# 金字塔和特征金字塔笔记

## 1. 图像金字塔 (Image Pyramid)

### 1.1 基本概念
图像金字塔是一种多尺度表示方法，通过不同分辨率对图像进行采样，形成金字塔结构。

### 1.2 数学原理

#### 高斯金字塔 (Gaussian Pyramid)
高斯金字塔通过高斯模糊和下采样构建：

**高斯模糊公式：**
$$G_{\sigma}(x,y) = \frac{1}{2\pi\sigma^2}e^{-\frac{x^2+y^2}{2\sigma^2}}$$

**下采样公式：**
$$I_{l+1}(i,j) = \sum_{m=-2}^{2}\sum_{n=-2}^{2}w(m,n)I_l(2i+m,2j+n)$$

其中：
- $I_l$：第l层图像
- $w(m,n)$：高斯权重核
- $\sigma$：高斯核标准差

#### 拉普拉斯金字塔 (Laplacian Pyramid)
拉普拉斯金字塔用于图像重建：
$$L_l = I_l - \text{Expand}(I_{l+1})$$

其中Expand为上采样操作。

### 1.3 架构
```
Level 0: 原始图像 (最高分辨率)
Level 1: 下采样2倍
Level 2: 下采样4倍
Level 3: 下采样8倍
...
```

### 1.4 实现代码
```python
import cv2
import numpy as np

def build_gaussian_pyramid(image, levels):
    """构建高斯金字塔"""
    pyramid = [image]
    for i in range(levels-1):
        image = cv2.pyrDown(image)
        pyramid.append(image)
    return pyramid

def build_laplacian_pyramid(gaussian_pyramid):
    """构建拉普拉斯金字塔"""
    pyramid = []
    for i in range(len(gaussian_pyramid)-1):
        size = (gaussian_pyramid[i].shape[1], gaussian_pyramid[i].shape[0])
        expanded = cv2.pyrUp(gaussian_pyramid[i+1], dstsize=size)
        laplacian = cv2.subtract(gaussian_pyramid[i], expanded)
        pyramid.append(laplacian)
    pyramid.append(gaussian_pyramid[-1])  # 顶层为高斯金字塔顶层
    return pyramid

# 使用示例
image = cv2.imread('image.jpg')
gaussian_pyr = build_gaussian_pyramid(image, 4)
laplacian_pyr = build_laplacian_pyramid(gaussian_pyr)
```

## 2. 特征金字塔网络 (Feature Pyramid Network, FPN)

### 2.1 基本概念
FPN是一种用于目标检测的多尺度特征提取架构，能够有效处理不同大小的物体。

### 2.2 数学原理

#### 特征融合公式
$$P_l = \text{Conv}_{1\times1}(C_l) + \text{Upsample}(P_{l+1})$$

其中：
- $C_l$：骨干网络第l层特征图
- $P_l$：FPN第l层输出特征图
- $\text{Conv}_{1\times1}$：1×1卷积降维
- $\text{Upsample}$：上采样操作

#### 特征图尺寸关系
$$\text{Size}(P_l) = \frac{\text{Size}(P_{l-1})}{2}$$

### 2.3 架构设计
```
输入图像
    ↓
骨干网络 (如ResNet)
    ↓
C2, C3, C4, C5 (不同层特征)
    ↓
自顶向下路径 + 横向连接
    ↓
P2, P3, P4, P5 (多尺度特征图)
    ↓
检测头 (分类 + 回归)
```

### 2.4 实现代码
```python
import torch
import torch.nn as nn
import torch.nn.functional as F

class FPN(nn.Module):
    def __init__(self, in_channels_list, out_channels=256):
        super(FPN, self).__init__()
        
        # 横向连接的1x1卷积
        self.lateral_convs = nn.ModuleList([
            nn.Conv2d(in_channels, out_channels, 1)
            for in_channels in in_channels_list
        ])
        
        # 特征融合的3x3卷积
        self.fpn_convs = nn.ModuleList([
            nn.Conv2d(out_channels, out_channels, 3, padding=1)
            for _ in in_channels_list
        ])
        
    def forward(self, inputs):
        # inputs: [C2, C3, C4, C5] 来自骨干网络
        
        # 自底向上路径
        laterals = [
            lateral_conv(inputs[i])
            for i, lateral_conv in enumerate(self.lateral_convs)
        ]
        
        # 自顶向下路径
        for i in range(len(laterals) - 2, -1, -1):
            laterals[i] += F.interpolate(
                laterals[i + 1], 
                size=laterals[i].shape[-2:], 
                mode='nearest'
            )
        
        # 最终特征融合
        outputs = [
            fpn_conv(laterals[i])
            for i, fpn_conv in enumerate(self.fpn_convs)
        ]
        
        return outputs

# 使用示例
in_channels_list = [256, 512, 1024, 2048]  # ResNet特征通道数
fpn = FPN(in_channels_list)
features = [torch.randn(1, c, h, w) for c, (h, w) in zip(in_channels_list, [(256,256), (128,128), (64,64), (32,32)])]
outputs = fpn(features)
```

## 3. 关键论文参考

### 3.1 图像金字塔相关
1. **Burt, P. J., & Adelson, E. H. (1983).** *The Laplacian Pyramid as a Compact Image Code*
   - 首次提出拉普拉斯金字塔
   - [论文链接](https://ieeexplore.ieee.org/document/1455848)

2. **Lindeberg, T. (1994).** *Scale-space theory in computer vision*
   - 尺度空间理论
   - [论文链接](https://link.springer.com/book/10.1007/978-1-4757-6465-9)

### 3.2 特征金字塔相关
1. **Lin, T. Y., et al. (2017).** *Feature Pyramid Networks for Object Detection*
   - FPN经典论文
   - [论文链接](https://arxiv.org/abs/1612.03144)

2. **Liu, W., et al. (2016).** *SSD: Single Shot MultiBox Detector*
   - 多尺度目标检测
   - [论文链接](https://arxiv.org/abs/1512.02325)

3. **Redmon, J., et al. (2016).** *You Only Look Once: Unified, Real-Time Object Detection*
   - YOLO系列
   - [论文链接](https://arxiv.org/abs/1506.02640)

## 4. 应用场景

### 4.1 图像金字塔应用
- 图像融合
- 图像压缩
- 多尺度图像处理
- 图像金字塔匹配

### 4.2 特征金字塔应用
- 目标检测 (Faster R-CNN, RetinaNet)
- 实例分割 (Mask R-CNN)
- 关键点检测
- 多尺度特征学习

## 5. 性能对比

| 方法 | 优点 | 缺点 |
|------|------|------|
| 图像金字塔 | 简单直观，重建质量高 | 计算量大，内存占用多 |
| FPN | 计算效率高，端到端训练 | 需要预训练骨干网络 |

---
*最后更新: 2024年*