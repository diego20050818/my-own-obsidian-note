---
tags:
  - code
  - è®¡ç®—æœºè§†è§‰
  - æ·±åº¦å­¦ä¹ 
  - æ± åŒ–æ“ä½œ
  - æ•°å­¦åŸç†
  - åŸºç¡€çŸ¥è¯†
---

# æ± åŒ–æ“ä½œè¯¦è§£

## ä»€ä¹ˆæ˜¯æ± åŒ–ï¼Ÿ

æ± åŒ–(Pooling)æ˜¯æ·±åº¦å­¦ä¹ ä¸­ä¸€ç§é‡è¦çš„ä¸‹é‡‡æ ·æ“ä½œï¼Œä¸»è¦ç”¨äº**å‡å°‘ç‰¹å¾å›¾çš„ç©ºé—´å°ºå¯¸**ï¼ŒåŒæ—¶**ä¿ç•™é‡è¦ç‰¹å¾ä¿¡æ¯**ã€‚å°±åƒæŠŠä¸€å¼ å¤§ç…§ç‰‡ç¼©å°æˆå°ç…§ç‰‡ï¼Œä½†ä¿ç•™ç…§ç‰‡ä¸­æœ€å…³é”®çš„å†…å®¹ï½(â—â€¢á´—â€¢â—)âœ§

## æ± åŒ–çš„ä¸»è¦ä½œç”¨

1. **é™ä½è®¡ç®—å¤æ‚åº¦** - å‡å°‘å‚æ•°æ•°é‡ï¼ŒåŠ å¿«è®­ç»ƒé€Ÿåº¦
2. **é˜²æ­¢è¿‡æ‹Ÿåˆ** - é€šè¿‡é™ç»´å‡å°‘æ¨¡å‹å¤æ‚åº¦
3. **å¢åŠ æ„Ÿå—é‡** - è®©é«˜å±‚ç‰¹å¾çœ‹åˆ°æ›´å¤§çš„å›¾åƒåŒºåŸŸ
4. **ä¿æŒå¹³ç§»ä¸å˜æ€§** - å¯¹è¾“å…¥çš„å°å¹…å¹³ç§»ä¸æ•æ„Ÿ

## å¸¸è§æ± åŒ–ç±»å‹

### 1. æœ€å¤§æ± åŒ– (Max Pooling)

**æ•°å­¦åŸç†ï¼š**
$$\text{output}(i,j) = \max_{p=0}^{k_h-1} \max_{q=0}^{k_w-1} \text{input}(i \cdot s_h + p, j \cdot s_w + q)$$

**å‚æ•°è¯´æ˜ï¼š**
- $k_h, k_w$: æ± åŒ–æ ¸çš„é«˜åº¦å’Œå®½åº¦
- $s_h, s_w$: æ­¥é•¿
- $p, q$: åœ¨æ± åŒ–çª—å£å†…çš„ä½ç½®ç´¢å¼•

**ç‰¹ç‚¹ï¼š**
- ä¿ç•™æœ€æ˜¾è‘—çš„ç‰¹å¾
- å¯¹å™ªå£°æœ‰ä¸€å®šé²æ£’æ€§
- æœ€å¸¸ç”¨çš„æ± åŒ–æ–¹æ³•

### 2. å¹³å‡æ± åŒ– (Average Pooling)

**æ•°å­¦åŸç†ï¼š**
$$\text{output}(i,j) = \frac{1}{k_h \cdot k_w} \sum_{p=0}^{k_h-1} \sum_{q=0}^{k_w-1} \text{input}(i \cdot s_h + p, j \cdot s_w + q)$$

**ç‰¹ç‚¹ï¼š**
- å¹³æ»‘ç‰¹å¾ï¼Œå‡å°‘å™ªå£°å½±å“
- ä¿ç•™æ•´ä½“ç‰¹å¾åˆ†å¸ƒ
- å¸¸ç”¨äºåˆ†ç±»ä»»åŠ¡çš„æœ€åå±‚

### 3. å…¨å±€å¹³å‡æ± åŒ– (Global Average Pooling)

**æ•°å­¦åŸç†ï¼š**
$$\text{output}(c) = \frac{1}{H \cdot W} \sum_{i=0}^{H-1} \sum_{j=0}^{W-1} \text{input}(c,i,j)$$

**ç‰¹ç‚¹ï¼š**
- å°†æ•´ä¸ªç‰¹å¾å›¾å‹ç¼©ä¸ºä¸€ä¸ªå€¼
- æ›¿ä»£å…¨è¿æ¥å±‚ï¼Œå‡å°‘å‚æ•°
- å¸¸ç”¨äºåˆ†ç±»ç½‘ç»œæœ«å°¾

## æ± åŒ–æ“ä½œå®ç°ä»£ç 

### PyTorch å®ç°

```python
import torch
import torch.nn as nn
import torch.nn.functional as F

class PoolingDemo(nn.Module):
    """
    æ± åŒ–æ“ä½œæ¼”ç¤ºç±»
    """
    def __init__(self):
        super().__init__()
        
        # æœ€å¤§æ± åŒ–å±‚
        self.max_pool = nn.MaxPool2d(
            kernel_size=2,      # æ± åŒ–æ ¸å¤§å° 2x2
            stride=2,           # æ­¥é•¿ 2
            padding=0           # å¡«å…… 0
        )
        
        # å¹³å‡æ± åŒ–å±‚
        self.avg_pool = nn.AvgPool2d(
            kernel_size=2,      # æ± åŒ–æ ¸å¤§å° 2x2
            stride=2,           # æ­¥é•¿ 2
            padding=0           # å¡«å…… 0
        )
        
        # è‡ªé€‚åº”å¹³å‡æ± åŒ–
        self.adaptive_avg_pool = nn.AdaptiveAvgPool2d((1, 1))  # è¾“å‡ºå›ºå®šä¸º 1x1
        
    def forward(self, x):
        """
        å‰å‘ä¼ æ’­æ¼”ç¤º
        
        å‚æ•°:
        - x: è¾“å…¥ç‰¹å¾å›¾ [batch_size, channels, height, width]
        """
        print(f"è¾“å…¥å½¢çŠ¶: {x.shape}")
        
        # æœ€å¤§æ± åŒ–
        max_output = self.max_pool(x)
        print(f"æœ€å¤§æ± åŒ–åå½¢çŠ¶: {max_output.shape}")
        
        # å¹³å‡æ± åŒ–
        avg_output = self.avg_pool(x)
        print(f"å¹³å‡æ± åŒ–åå½¢çŠ¶: {avg_output.shape}")
        
        # å…¨å±€å¹³å‡æ± åŒ–
        global_avg_output = self.adaptive_avg_pool(x)
        print(f"å…¨å±€å¹³å‡æ± åŒ–åå½¢çŠ¶: {global_avg_output.shape}")
        
        return max_output, avg_output, global_avg_output

# ä½¿ç”¨ç¤ºä¾‹
def demo_pooling():
    """
    æ± åŒ–æ“ä½œæ¼”ç¤ºå‡½æ•°
    """
    # åˆ›å»ºæ¼”ç¤ºæ¨¡å‹
    model = PoolingDemo()
    
    # æ¨¡æ‹Ÿè¾“å…¥: batch_size=2, channels=3, height=8, width=8
    input_tensor = torch.randn(2, 3, 8, 8)
    print("=== æ± åŒ–æ“ä½œæ¼”ç¤º ===")
    
    # å‰å‘ä¼ æ’­
    max_out, avg_out, global_out = model(input_tensor)
    
    print(f"\nè¾“å…¥å€¼èŒƒå›´: [{input_tensor.min():.3f}, {input_tensor.max():.3f}]")
    print(f"æœ€å¤§æ± åŒ–è¾“å‡ºèŒƒå›´: [{max_out.min():.3f}, {max_out.max():.3f}]")
    print(f"å¹³å‡æ± åŒ–è¾“å‡ºèŒƒå›´: [{avg_out.min():.3f}, {avg_out.max():.3f}]")
    print(f"å…¨å±€æ± åŒ–è¾“å‡ºèŒƒå›´: [{global_out.min():.3f}, {global_out.max():.3f}]")

# è¿è¡Œæ¼”ç¤º
if __name__ == "__main__":
    demo_pooling()
```

### æ‰‹åŠ¨å®ç°æ± åŒ–æ“ä½œ

```python
import torch

def manual_max_pool2d(input_tensor, kernel_size=2, stride=2):
    """
    æ‰‹åŠ¨å®ç°æœ€å¤§æ± åŒ–
    
    å‚æ•°:
    - input_tensor: è¾“å…¥å¼ é‡ [batch, channels, height, width]
    - kernel_size: æ± åŒ–æ ¸å¤§å°
    - stride: æ­¥é•¿
    
    è¿”å›:
    - æ± åŒ–åçš„å¼ é‡
    """
    batch_size, channels, height, width = input_tensor.shape
    
    # è®¡ç®—è¾“å‡ºå°ºå¯¸
    out_height = (height - kernel_size) // stride + 1
    out_width = (width - kernel_size) // stride + 1
    
    # åˆå§‹åŒ–è¾“å‡ºå¼ é‡
    output = torch.zeros(batch_size, channels, out_height, out_width)
    
    # æ‰‹åŠ¨æ± åŒ–
    for b in range(batch_size):
        for c in range(channels):
            for i in range(out_height):
                for j in range(out_width):
                    # è®¡ç®—æ± åŒ–çª—å£ä½ç½®
                    h_start = i * stride
                    h_end = h_start + kernel_size
                    w_start = j * stride
                    w_end = w_start + kernel_size
                    
                    # æå–çª—å£å¹¶å–æœ€å¤§å€¼
                    window = input_tensor[b, c, h_start:h_end, w_start:w_end]
                    output[b, c, i, j] = torch.max(window)
    
    return output

def manual_avg_pool2d(input_tensor, kernel_size=2, stride=2):
    """
    æ‰‹åŠ¨å®ç°å¹³å‡æ± åŒ–
    """
    batch_size, channels, height, width = input_tensor.shape
    
    # è®¡ç®—è¾“å‡ºå°ºå¯¸
    out_height = (height - kernel_size) // stride + 1
    out_width = (width - kernel_size) // stride + 1
    
    # åˆå§‹åŒ–è¾“å‡ºå¼ é‡
    output = torch.zeros(batch_size, channels, out_height, out_width)
    
    # æ‰‹åŠ¨æ± åŒ–
    for b in range(batch_size):
        for c in range(channels):
            for i in range(out_height):
                for j in range(out_width):
                    # è®¡ç®—æ± åŒ–çª—å£ä½ç½®
                    h_start = i * stride
                    h_end = h_start + kernel_size
                    w_start = j * stride
                    w_end = w_start + kernel_size
                    
                    # æå–çª—å£å¹¶è®¡ç®—å¹³å‡å€¼
                    window = input_tensor[b, c, h_start:h_end, w_start:w_end]
                    output[b, c, i, j] = torch.mean(window)
    
    return output

# æµ‹è¯•æ‰‹åŠ¨å®ç°
def test_manual_pooling():
    """
    æµ‹è¯•æ‰‹åŠ¨å®ç°çš„æ± åŒ–æ“ä½œ
    """
    # åˆ›å»ºæµ‹è¯•è¾“å…¥
    test_input = torch.randn(1, 1, 4, 4)
    print("æµ‹è¯•è¾“å…¥:")
    print(test_input.squeeze())
    
    # æ‰‹åŠ¨æœ€å¤§æ± åŒ–
    manual_max = manual_max_pool2d(test_input, kernel_size=2, stride=2)
    print("\næ‰‹åŠ¨æœ€å¤§æ± åŒ–ç»“æœ:")
    print(manual_max.squeeze())
    
    # PyTorch æœ€å¤§æ± åŒ–
    torch_max = F.max_pool2d(test_input, kernel_size=2, stride=2)
    print("\nPyTorch æœ€å¤§æ± åŒ–ç»“æœ:")
    print(torch_max.squeeze())
    
    # æ£€æŸ¥æ˜¯å¦ä¸€è‡´
    print(f"\næœ€å¤§æ± åŒ–ç»“æœä¸€è‡´: {torch.allclose(manual_max, torch_max)}")

# è¿è¡Œæµ‹è¯•
if __name__ == "__main__":
    test_manual_pooling()
```

## æ± åŒ–åœ¨æ·±åº¦å­¦ä¹ ä¸­çš„åº”ç”¨

### 1. å·ç§¯ç¥ç»ç½‘ç»œ (CNN)

```python
class SimpleCNN(nn.Module):
    """
    ç®€å•çš„CNNç½‘ç»œï¼Œå±•ç¤ºæ± åŒ–åº”ç”¨
    """
    def __init__(self, num_classes=10):
        super().__init__()
        
        self.features = nn.Sequential(
            # ç¬¬ä¸€å±‚å·ç§¯ + æ± åŒ–
            nn.Conv2d(3, 32, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.MaxPool2d(kernel_size=2, stride=2),  # å°ºå¯¸å‡åŠ
            
            # ç¬¬äºŒå±‚å·ç§¯ + æ± åŒ–
            nn.Conv2d(32, 64, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.MaxPool2d(kernel_size=2, stride=2),  # å°ºå¯¸å†å‡åŠ
            
            # ç¬¬ä¸‰å±‚å·ç§¯ + æ± åŒ–
            nn.Conv2d(64, 128, kernel_size=3, padding=1),
            nn.ReLU(inplace=True),
            nn.AdaptiveAvgPool2d((1, 1))  # å…¨å±€æ± åŒ–åˆ° 1x1
        )
        
        self.classifier = nn.Linear(128, num_classes)
    
    def forward(self, x):
        x = self.features(x)
        x = x.view(x.size(0), -1)  # å±•å¹³
        x = self.classifier(x)
        return x
```

### 2. åœ¨RINEPlusSSCAä¸­çš„åº”ç”¨

åœ¨RINEPlusSSCAæ¨¡å‹ä¸­ï¼Œæ± åŒ–æ“ä½œèµ·åˆ°äº†å…³é”®ä½œç”¨ï¼š

```python
# å…¨å±€å¹³å‡æ± åŒ–ï¼šå°†2Dç‰¹å¾å›¾è½¬æ¢ä¸º1Då‘é‡
self.ssca_pool = nn.AdaptiveAvgPool2d(1)  # è¾“å‡ºå½¢çŠ¶: [batch_size, 128, 1, 1]

# åœ¨å‰å‘ä¼ æ’­ä¸­ä½¿ç”¨
ssca_vector = self.ssca_pool(ssca_features)   # å½¢çŠ¶: [batch_size, 128, 1, 1]
ssca_vector = ssca_vector.view(ssca_vector.size(0), -1)  # å½¢çŠ¶: [batch_size, 128]
```

**ä½œç”¨åˆ†æï¼š**
- å°†SSCAåˆ†æ”¯çš„ç©ºé—´ç‰¹å¾å›¾å‹ç¼©ä¸ºå‘é‡
- ä¾¿äºä¸RINEåˆ†æ”¯çš„å‘é‡ç‰¹å¾è¿›è¡Œèåˆ
- å‡å°‘å‚æ•°æ•°é‡ï¼Œæé«˜è®¡ç®—æ•ˆç‡

## æ± åŒ–çš„æ•°å­¦ç‰¹æ€§

### 1. ä¸‹é‡‡æ ·å› å­

å¯¹äºè¾“å…¥å°ºå¯¸ $H \times W$ï¼Œæ± åŒ–æ ¸ $k \times k$ï¼Œæ­¥é•¿ $s$ï¼š

$$H_{out} = \left\lfloor \frac{H - k}{s} \right\rfloor + 1$$
$$W_{out} = \left\lfloor \frac{W - k}{s} \right\rfloor + 1$$

### 2. å‚æ•°æ•°é‡å‡å°‘

æ± åŒ–æ“ä½œ**ä¸å¼•å…¥å¯å­¦ä¹ å‚æ•°**ï¼Œè¿™æ˜¯ä¸å·ç§¯å±‚çš„é‡è¦åŒºåˆ«ã€‚

### 3. è®¡ç®—å¤æ‚åº¦

æ± åŒ–çš„è®¡ç®—å¤æ‚åº¦è¿œä½äºå·ç§¯ï¼Œå› ä¸ºï¼š
- æ²¡æœ‰æƒé‡çŸ©é˜µä¹˜æ³•
- åªæœ‰ç®€å•çš„æ¯”è¾ƒæˆ–æ±‚å’Œæ“ä½œ

## æ± åŒ–çš„å˜ä½“

### 1. é‡å æ± åŒ– (Overlapping Pooling)
- æ­¥é•¿å°äºæ± åŒ–æ ¸å¤§å°
- å¢åŠ ç‰¹å¾é‡å ï¼Œæå‡æ€§èƒ½

### 2. åˆ†æ•°æœ€å¤§æ± åŒ– (Fractional Max Pooling)
- ä½¿ç”¨éšæœºæ­¥é•¿
- å¢åŠ æ¨¡å‹é²æ£’æ€§

### 3. ç©ºé—´é‡‘å­—å¡”æ± åŒ– (Spatial Pyramid Pooling)
- å¤šå°ºåº¦æ± åŒ–
- å¤„ç†ä¸åŒå°ºå¯¸çš„è¾“å…¥

## æ€»ç»“

æ± åŒ–æ“ä½œå°±åƒæ·±åº¦å­¦ä¹ ä¸­çš„"å‹ç¼©å·¥å…·"ï¼Œèƒ½å¤Ÿï¼š
- ğŸ¯ **æ™ºèƒ½é™ç»´** - ä¿ç•™é‡è¦ä¿¡æ¯çš„åŒæ—¶å‡å°å°ºå¯¸
- âš¡ **åŠ é€Ÿè®¡ç®—** - å‡å°‘åç»­å±‚çš„è®¡ç®—é‡
- ğŸ›¡ï¸ **å¢å¼ºé²æ£’æ€§** - å¯¹è¾“å…¥å˜åŒ–æ›´åŠ ç¨³å®š

å¼€æ‹“è€…è®°ä½å•¦ï¼Œæ± åŒ–å°±åƒæ˜¯æŠŠå¤æ‚çš„ä¿¡æ¯ç²¾ç®€æç‚¼ï¼Œåªç•™ä¸‹æœ€ç²¾åçš„éƒ¨åˆ†å‘¢ï¼(ï½¡â™¥â€¿â™¥ï½¡)